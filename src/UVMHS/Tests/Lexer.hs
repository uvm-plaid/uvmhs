module UVMHS.Tests.Lexer (blockifyArgs,lexer,g__TESTS__UVMHS__Tests__Lexer) where

import UVMHS.Core

import UVMHS.Lib.Parser
import UVMHS.Lib.Pretty
import UVMHS.Lib.Testing
import UVMHS.Lib.Parser.Blockify
import UVMHS.Lib.Parser.Regex (mkIndentTokenWSBasic,blockTWSBasicL)

syntax ‚à∑ LexerWSBasicSyntax
syntax = concat
  [ lexerWSBasicSyntaxPunsMk   $ pow ["(",")",",","[","]",";"]
  , lexerWSBasicSyntaxBlocksMk $ pow ["local"]
  ]

lexer ‚à∑ Lexer CharClass ‚ÑÇ TokenClassWSBasic ‚Ñï64 TokenWSBasic
lexer = lexerWSBasic syntax

blockifyArgs ‚à∑ ùïä ‚Üí ùîπ ‚Üí ùëÜ (ParserToken TokenWSBasic) ‚Üí BlockifyArgs TokenWSBasic
blockifyArgs so anchorTL = BlockifyArgs so anchorTL mkIndentTokenWSBasic (NewlineTWSBasic "\n") (shape blockTWSBasicL) bracketOpens bracketSeps bracketCloses closeBracket
  where
    bracketOpens = pow $ map (\ s ‚Üí s :* SyntaxTWSBasic s) ["(","["]
    bracketSeps = pow $ map (\ s ‚Üí s :* SyntaxTWSBasic s) [",",";"]
    bracketCloses = pow $ map (\ s ‚Üí s :* SyntaxTWSBasic s) [")","]"]
    closeBracket = dict
      [ SyntaxTWSBasic "(" ‚Ü¶ BlockifyBracketArg (single $ SyntaxTWSBasic ",") (single $ SyntaxTWSBasic ")")
      , SyntaxTWSBasic "[" ‚Ü¶ BlockifyBracketArg (single $ SyntaxTWSBasic ";") (single $ SyntaxTWSBasic "]")
      ]

lexerTestANew ‚à∑ ùïä ‚Üí ùïä
lexerTestANew s = elimChoice ppshow ppshow $ do
  ts ‚Üê finalizeTokens ^$ tokenize lexer "<>" $ tokens s
  ts' ‚Üê blockify $ blockifyArgs "<>" True $ stream ts
  return $ renderParserTokens $ finalizeTokens $ vec ts'

lexerTestUNew ‚à∑ ùïä ‚Üí ùïä
lexerTestUNew s = ppshow $ viewŒ© inrL $ do
  ts ‚Üê finalizeTokens ^$ tokenize lexer "<>" $ tokens s
  ts' ‚Üê blockify $ blockifyArgs "<>" False $ stream ts
  return $ renderParserTokens $ finalizeTokens $ vec ts'

lexerTestA ‚à∑ ùïä ‚Üí ùïä
lexerTestA = lexerTestANew

lexerTestU ‚à∑ ùïä ‚Üí ùïä
lexerTestU = lexerTestUNew

-- ======== --
-- ANCHORED --
-- ======== --

-----------------------
-- top level newline --
-----------------------

ùî± "lexer:anchored:top-level-newline" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "c d"
       , "e f" 
       , "g h"
       ] 
  |] 
  [| concat $ inbetween "\n" 
       [ "a b;"
       , "c d;"
       , "e f;" 
       , "g h" 
       ]
  |]
-- TODO: how do we want this one to lex? as written? or error?
ùî± "lexer:anchored:top-level-newline" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "  a b"
       , "c d"
       , "e f" 
       , "g h"
       ] 
  |] 
  [| concat $ inbetween "\n" 
       [ "  a b;"
       , "c d;"
       , "e f;" 
       , "g h"
       ]
  |]
ùî± "lexer:anchored:top-level-newline" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "  c d"
       , "e f" 
       , "g h" 
       ] 
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "  c d;"
       , "e f;" 
       , "g h" 
       ]
  |]
ùî± "lexer:anchored:top-level-newline" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "c d"
       , "  e f" 
       , "g h"
       ] 
  |] 
  [| concat $ inbetween "\n" 
       [ "a b;"
       , "c d"
       , "  e f;" 
       , "g h"
       ]
  |]
ùî± "lexer:anchored:top-level-newline" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "local"
       , "c d"
       , "e f" 
       , "g h"
       ] 
  |] 
  [| concat $ inbetween "\n" 
       [ "a b;"
       , "local{};"
       , "c d;"
       , "e f;" 
       , "g h"
       ]
  |]
ùî± "lexer:anchored:top-level-newline" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "c d"
       , "e f" 
       , "g h"
       , "local"
       ] 
  |] 
  [| concat $ inbetween "\n" 
       [ "a b;"
       , "c d;"
       , "e f;" 
       , "g h;"
       , "local{}"
       ]
  |]
ùî± "lexer:anchored:top-level-newline" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "c d"
       , "e f" 
       , "g h"
       , "local"
       , "  i"
       , "  local" 
       ] 
  |] 
  [| concat $ inbetween "\n" 
       [ "a b;"
       , "c d;"
       , "e f;" 
       , "g h;"
       , "local{"
       , "  i;"
       , "  local{}}"
       ]
  |]
ùî± "lexer:anchored:top-level-newline" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "c d"
       , "e f" 
       , "g h"
       , "local"
       , "  local" 
       ] 
  |] 
  [| concat $ inbetween "\n" 
       [ "a b;"
       , "c d;"
       , "e f;" 
       , "g h;"
       , "local{"
       , "  local{}}"
       ]
  |]

----------------------
-- block same line  --
----------------------

ùî± "lexer:anchored:block-same-line" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "local c d"
       , "e f" 
       , "g h"
       ] 
  |] 
  [| concat $ inbetween "\n" 
       [ "a b;"
       , "local{ c d};"
       , "e f;"
       , "g h" 
       ]
  |]
ùî± "lexer:anchored:block-same-line" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "local c d"
       , "  e f"
       , "g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b;"
       , "local{ c d}"
       , "  e f;"
       , "g h" 
       ]
  |]
ùî± "lexer:anchored:block-same-line" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "local c d"
       , "      e f"
       , "g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b;"
       , "local{ c d;"
       , "      e f};"
       , "g h" 
       ]
  |]
ùî± "lexer:anchored:block-same-line" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "local c d"
       , "        e f"
       , "g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b;"
       , "local{ c d"
       , "        e f};"
       , "g h" 
       ]
  |]
ùî± "lexer:anchored:block-same-line" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "local c d"
       , "      e f"
       , "  g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b;"
       , "local{ c d;"
       , "      e f}"
       , "  g h" 
       ]
  |]
ùî± "lexer:anchored:block-same-line" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "local c d"
       , "e f"
       , "  g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b;"
       , "local{ c d};"
       , "e f"
       , "  g h" 
       ]
  |]
ùî± "lexer:anchored:block-same-line" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "local"
       , "    local c d"
       , "  e f"
       , "g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b;"
       , "local{"
       , "    local{ c d}}"
       , "  e f;"
       , "g h" 
       ]
  |]
ùî± "lexer:anchored:block-same-line" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "local"
       , "    local"
       , "  e f"
       , "g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b;"
       , "local{"
       , "    local{}}"
       , "  e f;"
       , "g h" 
       ]
  |]

---------------------
-- block next line --
---------------------

ùî± "lexer:anchored:block-next-line" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "local"
       , "    c d"
       , "e f"
       , "g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b;"
       , "local{"
       , "    c d};"
       , "e f;"
       , "g h" 
       ]
  |]
ùî± "lexer:anchored:block-next-line" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "local"
       , "    c d"
       , "    e f"
       , "g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b;"
       , "local{"
       , "    c d;"
       , "    e f};"
       , "g h" 
       ]
  |]
ùî± "lexer:anchored:block-next-line" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "local"
       , "    c d"
       , "    e f"
       , "  g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b;"
       , "local{"
       , "    c d;"
       , "    e f}"
       , "  g h" 
       ]
  |]
ùî± "lexer:anchored:block-next-line" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "local"
       , "    c d"
       , "    e f"
       , "      g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b;"
       , "local{"
       , "    c d;"
       , "    e f"
       , "      g h}" 
       ]
  |]

-- corner cases --

ùî± "lexer:anchored:corner-cases" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ ""
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ ""
       ]
  |]
ùî± "lexer:anchored:corner-cases" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ ""
       , "a"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ ""
       , "a"
       ]
  |]
ùî± "lexer:anchored:corner-cases" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ ""
       , "  a"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ ""
       , "  a"
       ]
  |]
ùî± "lexer:anchored:corner-cases" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ ""
       , "a"
       , "b"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ ""
       , "a;"
       , "b"
       ]
  |]
ùî± "lexer:anchored:corner-cases" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ ""
       , "  a"
       , "b"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ ""
       , "  a;"
       , "b"
       ]
  |]
ùî± "lexer:anchored:corner-cases" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ ""
       , "local"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ ""
       , "local{}"
       ]
  |]
ùî± "lexer:anchored:corner-cases" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ ""
       , "  local"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ ""
       , "  local{}"
       ]
  |]
ùî± "lexer:anchored:corner-cases" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ ""
       , "  local"
       , "local"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ ""
       , "  local{};"
       , "local{}"
       ]
  |]

-- parens --

ùî± "lexer:anchored:parens" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "()"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "()"
       ]
  |]
ùî± "lexer:anchored:parens" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "(local)"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "(local{})"
       ]
  |]
ùî± "lexer:anchored:parens" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "local(local)"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "local{(local{})}"
       ]
  |]
ùî± "lexer:anchored:parens" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "(local(local))"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "(local{(local{})})"
       ]
  |]
ùî± "lexer:anchored:parens" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "(local"
       , "   local)"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "(local{"
       , "   local{}})"
       ]
  |]
ùî± "lexer:anchored:parens" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "(local"
       , "   local"
       , "     local"
       , "       a"
       , "       b)c"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "(local{"
       , "   local{"
       , "     local{"
       , "       a;"
       , "       b}}})c"
       ]
  |]
ùî± "lexer:anchored:parens" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "( local "
       , "    local a"
       , "    (b) c"
       , "    (d"
       , "     e)"
       , "  , d"
       , "  )"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "( local{ "
       , "    local{ a};"
       , "    (b) c;"
       , "    (d"
       , "     e)}"
       , "  , d"
       , "  )"
       ]
  |]
ùî± "lexer:anchored:parens" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "(local local,local local)"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "(local{ local{}},local{ local{}})"
       ]
  |]

-- ========== --
-- UNANCHORED --
-- ========== --

-----------------------
-- top level newline --
-----------------------

ùî± "lexer:unanchored:top-level-newline" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "c d"
       , "e f" 
       , "g h"
       ] 
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "c d"
       , "e f" 
       , "g h" 
       ]
  |]
-- TODO: how do we want this one to lex? as written? or error?
ùî± "lexer:unanchored:top-level-newline" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "  a b"
       , "c d"
       , "e f" 
       , "g h"
       ] 
  |] 
  [| concat $ inbetween "\n" 
       [ "  a b"
       , "c d"
       , "e f" 
       , "g h"
       ]
  |]
ùî± "lexer:unanchored:top-level-newline" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "  c d"
       , "e f" 
       , "g h" 
       ] 
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "  c d"
       , "e f" 
       , "g h" 
       ]
  |]
ùî± "lexer:unanchored:top-level-newline" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "c d"
       , "  e f" 
       , "g h"
       ] 
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "c d"
       , "  e f" 
       , "g h"
       ]
  |]
ùî± "lexer:unanchored:top-level-newline" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "local"
       , "c d"
       , "e f" 
       , "g h"
       ] 
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "local{}"
       , "c d"
       , "e f" 
       , "g h"
       ]
  |]
ùî± "lexer:unanchored:top-level-newline" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "c d"
       , "e f" 
       , "g h"
       , "local"
       ] 
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "c d"
       , "e f" 
       , "g h"
       , "local{}"
       ]
  |]
ùî± "lexer:unanchored:top-level-newline" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "c d"
       , "e f" 
       , "g h"
       , "local"
       , "  i"
       , "  local" 
       ] 
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "c d"
       , "e f" 
       , "g h"
       , "local{"
       , "  i;"
       , "  local{}}"
       ]
  |]
ùî± "lexer:unanchored:top-level-newline" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "c d"
       , "e f" 
       , "g h"
       , "local"
       , "  local" 
       ] 
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "c d"
       , "e f" 
       , "g h"
       , "local{"
       , "  local{}}"
       ]
  |]

----------------------
-- block same line  --
----------------------

ùî± "lexer:unanchored:block-same-line" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "local c d"
       , "e f" 
       , "g h"
       ] 
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "local{ c d}"
       , "e f"
       , "g h" 
       ]
  |]
ùî± "lexer:unanchored:block-same-line" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "local c d"
       , "  e f"
       , "g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "local{ c d}"
       , "  e f"
       , "g h" 
       ]
  |]
ùî± "lexer:unanchored:block-same-line" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "local c d"
       , "      e f"
       , "g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "local{ c d;"
       , "      e f}"
       , "g h" 
       ]
  |]
ùî± "lexer:unanchored:block-same-line" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "local c d"
       , "        e f"
       , "g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "local{ c d"
       , "        e f}"
       , "g h" 
       ]
  |]
ùî± "lexer:unanchored:block-same-line" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "local c d"
       , "      e f"
       , "  g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "local{ c d;"
       , "      e f}"
       , "  g h" 
       ]
  |]
ùî± "lexer:unanchored:block-same-line" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "local c d"
       , "e f"
       , "  g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "local{ c d}"
       , "e f"
       , "  g h" 
       ]
  |]
ùî± "lexer:unanchored:block-same-line" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "local"
       , "    local c d"
       , "  e f"
       , "g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "local{"
       , "    local{ c d}}"
       , "  e f"
       , "g h" 
       ]
  |]
ùî± "lexer:unanchored:block-same-line" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "local"
       , "    local"
       , "  e f"
       , "g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "local{"
       , "    local{}}"
       , "  e f"
       , "g h" 
       ]
  |]

---------------------
-- block next line --
---------------------

ùî± "lexer:unanchored:block-next-line" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "local"
       , "    c d"
       , "e f"
       , "g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "local{"
       , "    c d}"
       , "e f"
       , "g h" 
       ]
  |]
ùî± "lexer:unanchored:block-next-line" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "local"
       , "    c d"
       , "    e f"
       , "g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "local{"
       , "    c d;"
       , "    e f}"
       , "g h" 
       ]
  |]
ùî± "lexer:unanchored:block-next-line" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "local"
       , "    c d"
       , "    e f"
       , "  g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "local{"
       , "    c d;"
       , "    e f}"
       , "  g h" 
       ]
  |]
ùî± "lexer:unanchored:block-next-line" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "a b"
       , "local"
       , "    c d"
       , "    e f"
       , "      g h" 
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "a b"
       , "local{"
       , "    c d;"
       , "    e f"
       , "      g h}" 
       ]
  |]

-- corner cases --

ùî± "lexer:unanchored:corner-cases" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ ""
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ ""
       ]
  |]
ùî± "lexer:unanchored:corner-cases" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ ""
       , "a"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ ""
       , "a"
       ]
  |]
ùî± "lexer:unanchored:corner-cases" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ ""
       , "  a"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ ""
       , "  a"
       ]
  |]
ùî± "lexer:unanchored:corner-cases" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ ""
       , "a"
       , "b"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ ""
       , "a"
       , "b"
       ]
  |]
ùî± "lexer:unanchored:corner-cases" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ ""
       , "  a"
       , "b"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ ""
       , "  a"
       , "b"
       ]
  |]
ùî± "lexer:unanchored:corner-cases" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ ""
       , "local"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ ""
       , "local{}"
       ]
  |]
ùî± "lexer:unanchored:corner-cases" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ ""
       , "  local"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ ""
       , "  local{}"
       ]
  |]
ùî± "lexer:unanchored:corner-cases" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ ""
       , "  local"
       , "local"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ ""
       , "  local{}"
       , "local{}"
       ]
  |]

-- parens --

ùî± "lexer:unanchored:parens" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "()"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "()"
       ]
  |]
ùî± "lexer:unanchored:parens" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "(local)"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "(local{})"
       ]
  |]
ùî± "lexer:unanchored:parens" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "local(local)"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "local{(local{})}"
       ]
  |]
ùî± "lexer:unanchored:parens" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "(local(local))"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "(local{(local{})})"
       ]
  |]
ùî± "lexer:unanchored:parens" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "(local"
       , "   local)"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "(local{"
       , "   local{}})"
       ]
  |]
ùî± "lexer:unanchored:parens" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "(local"
       , "   local"
       , "     local"
       , "       a"
       , "       b)c"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "(local{"
       , "   local{"
       , "     local{"
       , "       a;"
       , "       b}}})c"
       ]
  |]
ùî± "lexer:unanchored:parens" 
  [| lexerTestU $ concat $ inbetween "\n"
       [ "( local "
       , "    local a"
       , "    (b) c"
       , "    (d"
       , "     e)"
       , "  , d"
       , "  )"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "( local{ "
       , "    local{ a};"
       , "    (b) c;"
       , "    (d"
       , "     e)}"
       , "  , d"
       , "  )"
       ]
  |]

-- ======= --
-- FAILURE --
-- ======= --

ùî± "lexer:anchored:failure" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "+ c d"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "Parse Failure"
       , "Source:"
       , "> <>"
       , "> line:2 column:1"
       , "One of:"
       , "a b"
       , "+ c d"
       , "^"
       , "Expected <token>"
       ]
  |]
ùî± "lexer:anchored:failure" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , ") c d"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "Parse Failure"
       , "Source:"
       , "> <>"
       , "> line:2 column:1"
       , "One of:"
       , "a b;"
       , ") c d"
       , "^"
       , "Expected matching bracket OPEN ‚Äπ(‚Ä∫ before this bracket CLOSE"
       ]
  |]
ùî± "lexer:anchored:failure" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "( c d"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "Parse Failure"
       , "Source:"
       , "> <>"
       , "> line:2 column:4"
       , "One of:"
       , "a b;"
       , "( c dEOF"
       , "     ^^^"
       , "Expected bracket CLOSE ‚Äπ)‚Ä∫ before END OF INPUT"
       ]
  |]
ùî± "lexer:anchored:failure" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , ", c d"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "Parse Failure"
       , "Source:"
       , "> <>"
       , "> line:2 column:1"
       , "One of:"
       , "a b;"
       , ", c d"
       , "^"
       , "Expected matching bracket OPEN ‚Äπ(‚Ä∫ before this bracket SEP"
       ]
  |]
ùî± "lexer:anchored:failure" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "(a b"
       , ") c d"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "Parse Failure"
       , "Source:"
       , "> <>"
       , "> line:2 column:1"
       , "One of:"
       , "(a b;"
       , ") c d"
       , "^"
       , "Expected bracket CLOSE ‚Äπ)‚Ä∫ before block NEWLINE triggered by this TOKEN"
       ]
  |]
ùî± "lexer:anchored:failure" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "(a b"
       , "c d"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "Parse Failure"
       , "Source:"
       , "> <>"
       , "> line:2 column:1"
       , "One of:"
       , "(a b;"
       , "c d"
       , "^"
       , "Expected bracket CLOSE ‚Äπ)‚Ä∫ before block NEWLINE triggered by this TOKEN"
       ]
  |]
ùî± "lexer:anchored:failure" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a local (a b"
       , ") c d"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "Parse Failure"
       , "Source:"
       , "> <>"
       , "> line:2 column:1"
       , "One of:"
       , "a local{ (a b}"
       , ") c d"
       , "^"
       , "Expected bracket CLOSE ‚Äπ)‚Ä∫ before block CLOSE triggered by this TOKEN"
       ]
  |]
ùî± "lexer:anchored:failure" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a local (a b"
       , "c d"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "Parse Failure"
       , "Source:"
       , "> <>"
       , "> line:2 column:1"
       , "One of:"
       , "a local{ (a b}"
       , "c d"
       , "^"
       , "Expected bracket CLOSE ‚Äπ)‚Ä∫ before block CLOSE triggered by this TOKEN"
       ]
  |]
ùî± "lexer:anchored:failure" 
  [| lexerTestA $ concat $ inbetween "\n"
       [ "a b"
       , "  ( c] d"
       ]
  |] 
  [| concat $ inbetween "\n" 
       [ "Parse Failure"
       , "Source:"
       , "> <>"
       , "> line:2 column:6"
       , "One of:"
       , "a b"
       , "  ( c] d"
       , "     ^"
       , "Expected matching bracket CLOSE ‚Äπ)‚Ä∫ before this bracket CLOSE"
       ]
  |]

buildTests
